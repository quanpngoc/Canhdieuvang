@{ 
    Validation.RequireField("account", "Xin hãy nhập tài khoản để tiếp tục!");
    Validation.RequireField("password", "Xin hãy nhập mật khẩu để tiếp tục!");

    int result_login = onPostAccount();

    <script type="text/javascript">
        if ("@result_login.ToString()" == "1")
            setTimeout(function () {
                alert("Đăng nhập không thành công, xin hãy kiểm tra lại!");
            }, 100);
        else if ("@result_login.ToString()" == "2") { 
            setTimeout(function () {
                alert("Đăng nhập thành công!");
            }, 100);
            $('.user-avatar img').attr('src', '@Session["accountImgUrl"]');
            $('#contact-us #customerName').val('@Session["userName"]');
            $('#contact-us #customerEmail').val('@Session["userEmail"]');
            location.reload();
        }
        else if ("@result_login.ToString()" == "4") {
            setTimeout(function () {
                alert("Đã đăng xuất tài khoản!");
            }, 100);
            $('.user-avatar img').attr('src', 'Images/user-black.png');
            $('#contact-us #customerName').val('');
            $('#contact-us #customerEmail').val('');
            location.reload();
        }
    </script>
}

@functions{

    //properties
    public string account { get; set; }
    public string password { get; set; }
    public string action { get; set; }

    public int onPostAccount()
    {
        if (IsPost)
        {
            account = Request.Form["account"];
            password = Request.Form["password"];
            encodePassword();
            action = Request.Form["action"];

            if(action == "login")
            {
                if (Session["userID"] != null && Session["userID"] != "")
                {
                    return 0;
                }

                IEnumerable<dynamic> accountInfo = null;

                if (Validation.IsValid())
                {
                    accountInfo = getAccount();
                }

                if(accountInfo != null && accountInfo.Count() > 0)
                {
                    if ((account == accountInfo.ElementAt(0).TenDangNhap || account == accountInfo.ElementAt(0).Email) && password == accountInfo.ElementAt(0).MatKhau)
                    {
                        Session["userID"] = accountInfo.ElementAt(0).MaNguoiDung;
                        Session["accountImgUrl"] = accountInfo.ElementAt(0).HinhAnhNguoiDung;
                        Session["userName"] = accountInfo.ElementAt(0).TenNguoiDung;
                        Session["userEmail"] = accountInfo.ElementAt(0).Email;
                        return 2;
                    }

                }
                return 1;
            }
            else if(action == "logout")
            {
                if (Session["userID"] == null || Session["userID"] == "")
                {
                    return 0;
                }
                Session["userID"] = "";
                Session["accountImgUrl"] = "";
                Session["userName"] = "";
                Session["userEmail"] = "";
                return 4;
            }
        }
        return 0;
    }

    public IEnumerable<dynamic> getAccount()
    {
        var db = Database.Open("DefaultConnection");

        var accountInfo = db.Query("SELECT * FROM Users where (TenDangNhap='"+ account +"' OR Email='" + account + "') and MatKhau='"+ password +"'");

        return accountInfo;

        db.Close();
    }

    public void encodePassword()
    {
        if(password != null && password != "")
            password = System.Web.Security.FormsAuthentication.HashPasswordForStoringInConfigFile(password.Trim(), "SHA1");
    }
}

<div id="login-popup">
    <i class="fa fa-close close-login-popup"></i>
    <div class="popup-content">

        @if (Session["userID"] == "" || Session["userID"] == null)
        {
            <h3 class="title"> Đăng nhập</h3>
            <form method="post">
                <input type="text" value="@Request.Form["account"]" placeholder="Nhập tên tài khoản hoặc địa chỉ email" name="account">
                @if (Html.ValidationMessage("account").ToString() != "")
                {
                    Html.ValidationMessage("account");
                }
                <input type="password" value="@Request.Form["password"]" placeholder="Nhập mật khẩu" name="password">
                @if (Html.ValidationMessage("account").ToString() != "")
                {
                    Html.ValidationMessage("account");
                }
                <input type="hidden" value="login" name="action" />
                <div class="col-md-12">
                    <input type="submit" id="login-btn" class="btn-view-more btn" value="ĐĂNG NHẬP" />
                </div>
            </form>
            <p>Nếu bạn chưa có tài khoản, hãy <a href="./signuppage.cshtml">đăng ký</a> ngay</p>
            <div class="mid-block">
                <hr>
                <h5>Hoặc</h5>
            </div>
            <div class="row">
                <div class="btn-grp">
                    <div id="facebook" class="item-group">
                        <a>
                            <i class="fa fa-facebook"></i>
                            <p>Đăng nhập bằng Facebook</p>
                        </a>
                    </div>
                    <div id="twitter" class="item-group">
                        <a>
                            <i class="fa fa-twitter"></i>
                            <p>Đăng nhập bằng Twitter</p>
                        </a>
                    </div>
                    <div id="google" class="item-group">
                        <a>
                            <i class="fa fa-google"></i>
                            <p>Đăng nhập bằng Google</p>
                        </a>
                    </div>
                </div>
            </div>
        }
        else
        {
            <h3 class="title"><img src="@Session["accountImgUrl"]" /></h3>
            <p style="font-weight:bold;">@Session["userName"]</p>
            <form method="post">
                <input type="hidden" value="logout" name="action" />
                <div class="col-md-12">
                    <input type="submit" id="logout-btn" class="btn-view-more btn" value="ĐĂNG XUẤT" />
                </div>
            </form>
        }
        @*<p><a>Quên mật khẩu</a></p>*@
    </div>
</div>